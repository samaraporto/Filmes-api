---
- name: Configurar servidor e instalar API Filmes
  hosts: app_servers
  become: true 
  vars:
    node_version: "18.x"
    app_dir: "/var/www/filmes-api"

  tasks:
    - name: Atualizar cache do apt (Ubuntu/Debian)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Instalar dependências básicas (curl, git, rsync)
      package:
        name:
          - curl
          - git
          - rsync
        state: present

    - name: Adicionar repositório do Node.js {{ node_version }}
      shell: "curl -fsSL https://deb.nodesource.com/setup_{{ node_version }} | bash -"
      args:
        creates: "/etc/apt/sources.list.d/nodesource.list"
      when: ansible_os_family == "Debian"

    - name: Instalar Node.js
      apt:
        name: nodejs
        state: present
      when: ansible_os_family == "Debian"

    - name: Criar diretório da aplicação
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user_id }}"

    # ALTERAÇÃO IMPORTANTE: Usando rsync via shell para garantir que os arquivos
    # sejam copiados para a raiz da pasta, e não criar uma subpasta.
    # O "strip-components=1" não se aplica aqui, mas o rsync com "*" sim.
    - name: Sincronizar arquivos (Forçando via Shell)
      shell: >
        rsync -av 
        --exclude='node_modules' 
        --exclude='.git' 
        --exclude='.github' 
        --exclude='ansible' 
        --exclude='coverage'
        --exclude='tests'
        "{{ playbook_dir }}/../" "{{ app_dir }}/"
      # O / no final de app_dir/ é importante!

    # DEBUG: Confirma se o package.json chegou no lugar certo
    - name: Verificar se package.json existe
      stat:
        path: "{{ app_dir }}/package.json"
      register: pjson

    - name: Falhar se o arquivo não estiver lá (Debug)
      fail:
        msg: "ERRO: O package.json não foi copiado para {{ app_dir }}. Verifique os caminhos."
      when: not pjson.stat.exists

    - name: Instalar dependências do projeto (npm install)
      npm:
        path: "{{ app_dir }}"
        production: yes

    - name: Instalar PM2 Globalmente
      npm:
        name: pm2
        global: yes
        state: present

    - name: Iniciar aplicação com PM2
      command: pm2 start src/server.js --name "filmes-api" --force
      args:
        chdir: "{{ app_dir }}"
      environment:
        PORT: 3000